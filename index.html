<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Dashboard Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Modern Design Variables */
        :root {
            --primary: #4f46e5; /* Indigo */
            --background: #0f172a; /* Slate-900 */
            --card-bg: #1e293b; /* Slate-800 */
            --text-color: #f1f5f9; /* Slate-100 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            background-color: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }
        .btn-primary {
            background-color: var(--primary);
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #6366f1;
        }
        /* Style for the Google button */
        #googleLoginButton {
            background-color: white;
            color: #1f2937; /* Dark text */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #googleLoginButton:hover {
            background-color: #f3f4f6;
        }
        .text-error {
            color: #f87171; /* Red-400 */
        }
    </style>
</head>
<body>
    <div id="app" class="w-full max-w-7xl p-4">

        <!-- ============================================== -->
        <!-- 1. AUTHENTICATION CONTAINER (Login/Register Gate) -->
        <!-- Starts Visible, hides on successful login -->
        <!-- ============================================== -->
        <div id="authContainer" class="card p-8 mx-auto max-w-lg">
            <h2 class="text-4xl font-extrabold mb-2 text-center text-white">Secure Access Portal</h2>
            <p id="authMessage" class="text-sm text-center mb-6 text-gray-400">Sign in to view your private dashboard.</p>
            <p id="loadingIndicator" class="text-yellow-400 text-center mb-4 hidden">Processing authentication...</p>

            <!-- Login/Register Forms Container -->
            <div id="authForms" class="space-y-4">
                
                <!-- LOGIN VIEW (Default) -->
                <div id="loginView">
                    <h3 class="text-2xl font-bold mb-4 text-white">Sign In</h3>

                    <input type="email" id="authEmailLogin" placeholder="Email" class="w-full p-3 mb-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:border-indigo-400">
                    <input type="password" id="authPasswordLogin" placeholder="Password (min 6 characters)" class="w-full p-3 mb-4 rounded-lg bg-slate-700 text-white border border-slate-600 focus:border-indigo-400">
                    
                    <button id="loginButton" class="btn-primary w-full py-3 text-lg font-semibold rounded-lg mb-4">
                        <i class="fas fa-sign-in-alt mr-2"></i> Log In
                    </button>
                    
                    <div class="flex items-center space-x-2 my-4">
                        <div class="flex-grow border-t border-slate-700"></div>
                        <span class="text-sm text-slate-500">OR</span>
                        <div class="flex-grow border-t border-slate-700"></div>
                    </div>

                    <button id="googleLoginButton" class="w-full py-3 text-lg font-semibold rounded-lg flex items-center justify-center space-x-3">
                        <!-- Use Font Awesome icon for Google -->
                        <i class="fab fa-google text-red-500 text-xl"></i> 
                        <span>Sign in with Google</span>
                    </button>

                    <button class="text-sm w-full text-slate-400 hover:text-indigo-400 pt-6" onclick="toggleAuthView('register')">
                        Don't have an account? Register Now
                    </button>
                </div>

                <!-- REGISTER VIEW (Hidden) -->
                <div id="registerView" class="hidden">
                    <h3 class="text-2xl font-bold mb-4 text-white">Register Account</h3>

                    <input type="text" id="registerName" placeholder="Full Name" class="w-full p-3 mb-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:border-indigo-400">
                    <input type="email" id="authEmailRegister" placeholder="Email" class="w-full p-3 mb-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:border-indigo-400">
                    <input type="password" id="authPasswordRegister" placeholder="Password (min 6 characters)" class="w-full p-3 mb-4 rounded-lg bg-slate-700 text-white border border-slate-600 focus:border-indigo-400">
                    
                    <button id="registerButton" class="btn-primary w-full py-3 text-lg font-semibold rounded-lg">
                        <i class="fas fa-user-plus mr-2"></i> Create Account
                    </button>

                    <button class="text-sm w-full text-slate-400 hover:text-indigo-400 pt-6" onclick="toggleAuthView('login')">
                        Already registered? Go to Sign In
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- 2. DASHBOARD CONTAINER (The Actual Website) -->
        <!-- Starts Hidden, shows on successful login -->
        <!-- ============================================== -->
        <div id="dashboardContainer" class="card p-10 mx-auto max-w-4xl text-center hidden">
            <i class="fas fa-rocket text-6xl text-indigo-400 mb-6"></i>
            <h1 class="text-5xl font-extrabold mb-2 text-white">Access Granted!</h1>
            <p id="welcomeMessage" class="text-xl text-gray-300 mb-8">Loading profile...</p>
            
            <div class="space-y-4 max-w-sm mx-auto">
                <p class="text-sm text-gray-500">This is your secure, authenticated content area.</p>
                
                <button id="logoutButton" class="w-full py-3 text-lg font-semibold rounded-lg bg-red-600 hover:bg-red-700 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i> Log Out
                </button>
            </div>
        </div>

    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Disable aggressive Firebase logging (optional, but cleaner)
        setLogLevel('Error');

        // Global environment variables (Canvas provides these)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // !!! IMPORTANT: Paste Your Firebase Config Here !!!
        const userFirebaseConfig = {
            "apiKey": "AIzaSyBiHrqtWWI7VhfJhWWy8DonXSUWLXOiJCA",
            "authDomain": "gta-web-app-5abcd.firebaseapp.com",
            "projectId": "gta-web-app-5abcd",
            "storageBucket": "gta-web-app-5abcd.firebasestorage.app",
            "messagingSenderId": "135809506245",
            "appId": "1:135809506245:web:9c7f5848f9a931f53d49ac"
        };
        // Use the hardcoded config since we're starting fresh
        const firebaseConfig = userFirebaseConfig;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthProcessing = false; // Flag to prevent rapid clicking

        // --- UI Feedback Helper ---
        function showAuthFeedback(message, type = 'error') {
            const authMessageEl = document.getElementById('authMessage');
            authMessageEl.textContent = message;
            authMessageEl.classList.remove('text-gray-400', 'text-green-400', 'text-error');
            authMessageEl.classList.add(type === 'success' ? 'text-green-400' : 'text-error');
            
            setTimeout(() => {
                authMessageEl.textContent = "Sign in to view your private dashboard.";
                authMessageEl.classList.remove('text-green-400', 'text-error');
                authMessageEl.classList.add('text-gray-400');
            }, 5000);
        }

        // --- Firestore Setup and Data Gate ---
        const getProgressDocRef = (uid) => doc(db, `artifacts/${appId}/users/${uid}/progress`, 'user_data');
        
        // This function acts as the Data Gate and performs the screen switch
        async function checkAndLoadUser() {
            if (!auth.currentUser || !db) return;

            const user = auth.currentUser;
            const progressRef = getProgressDocRef(user.uid);
            
            // 1. Fetch data (simplified for this demo: profile info)
            const docSnap = await getDoc(progressRef);
            
            if (!docSnap.exists()) {
                // If this is a brand new user (Google or Email/Password), save initial profile data
                await setDoc(progressRef, {
                    name: user.displayName || document.getElementById('registerName')?.value || 'New User',
                    email: user.email,
                    signedUpOn: new Date().toISOString()
                }, { merge: true });
            } else {
                // Use existing name from Firestore if available
                const savedData = docSnap.data();
                user.displayName = savedData.name || user.displayName;
            }

            // 2. SUCCESS: Hide Auth UI and show Dashboard
            document.getElementById('welcomeMessage').textContent = `Welcome, ${user.displayName || user.email}!`;
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('dashboardContainer').classList.remove('hidden');
            isAuthProcessing = false; // Release the lock
        }


        // --- Authentication Handlers ---

        async function handleEmailRegister() {
            if (isAuthProcessing) return;
            isAuthProcessing = true;
            document.getElementById('loadingIndicator').classList.remove('hidden');

            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('authEmailRegister').value.trim();
            const password = document.getElementById('authPasswordRegister').value;
            
            if (!name || !email || password.length < 6) {
                showAuthFeedback("Name, valid email, and 6+ character password required.");
                isAuthProcessing = false;
                document.getElementById('loadingIndicator').classList.add('hidden');
                return;
            }
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Immediately update the profile to set the display name
                await userCredential.user.updateProfile({ displayName: name });

                // We rely on the onAuthStateChanged listener and checkAndLoadUser to handle the UI transition
                // checkAndLoadUser will ensure the data is saved and the dashboard is displayed.

            } catch (error) {
                const msg = error.code === 'auth/email-already-in-use' ? "Email already exists. Please sign in." : error.message.split('(')[0];
                showAuthFeedback(`Registration Failed: ${msg}`);
                if (error.code === 'auth/email-already-in-use') toggleAuthView('login');
                isAuthProcessing = false;
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        async function handleEmailLogin() {
            if (isAuthProcessing) return;
            isAuthProcessing = true;
            document.getElementById('loadingIndicator').classList.remove('hidden');

            const email = document.getElementById('authEmailLogin').value.trim();
            const password = document.getElementById('authPasswordLogin').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // We rely on the onAuthStateChanged listener and checkAndLoadUser to handle the UI transition

            } catch (error) {
                showAuthFeedback("Login Failed: Invalid email or password.");
                isAuthProcessing = false;
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        async function handleGoogleLogin() {
            if (isAuthProcessing) return;
            isAuthProcessing = true;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                
                // We rely on the onAuthStateChanged listener and checkAndLoadUser to handle the UI transition

            } catch (error) {
                // Suppress the "popup closed by user" error on cancelation
                if (error.code !== 'auth/popup-closed-by-user') {
                    showAuthFeedback(`Google Login Failed: ${error.message.split('(')[0]}`);
                }
                isAuthProcessing = false;
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // onAuthStateChanged handles the screen switch
                isAuthProcessing = false;
            } catch (error) {
                showAuthFeedback(`Logout Failed: ${error.message}`);
            }
        }


        // --- Initialization ---
        window.onload = () => {
            // 1. Initialize Firebase services
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                 showAuthFeedback("Firebase Initialization Failed. Check your config keys.", 'error');
                 console.error("Firebase Init Error:", error);
                 return;
            }
            
            // 2. Set up the CRITICAL Auth Listener (The App Router)
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    // This calls the Data Gate check when we know a user is authenticated
                    checkAndLoadUser(); 
                } else {
                    // Logged Out: SHOW auth, HIDE dashboard
                    document.getElementById('authContainer').classList.remove('hidden');
                    document.getElementById('dashboardContainer').classList.add('hidden');
                }
            });

            // 3. Set up button listeners
            document.getElementById('loginButton').addEventListener('click', handleEmailLogin);
            document.getElementById('registerButton').addEventListener('click', handleEmailRegister);
            document.getElementById('googleLoginButton').addEventListener('click', handleGoogleLogin);
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
        };
    </script>
</body>
</html>
