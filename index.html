<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTA: Global Translation Adventures</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- Root Variables for Both Modes --- */
        :root {
            /* Dark Mode Defaults (as before) */
            --primary-red: #E03D4D;
            --background-deep: #1A1A1A;
            --card-dark: #2C2C2C;
            --text-light: #F9FAFB;
            --text-secondary: #AAAAAA;
            --success-green: #38A169;
            --danger-red: #E53E3E;
        }

        /* --- LIGHT MODE Variables --- */
        body.light-mode {
            --background-deep: #F3F4F6; /* Light Gray Background */
            --card-dark: #FFFFFF; /* White Cards */
            --text-light: #1F2937; /* Dark Text */
            --text-secondary: #6B7280;
            --primary-red: #E03D4D; /* Red remains constant */
            --success-green: #10B981; /* Brighter success green */
            --danger-red: #EF4444; /* Brighter danger red */
        }
        
        /* --- GLOBAL BASE STYLES --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-deep);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Main Game Screen Card Styling */
        .game-screen {
            max-width: 1000px;
            min-height: 80vh;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--card-dark);
            border-radius: 1rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            transition: background 0.3s, box-shadow 0.3s;
        }
        body.light-mode .game-screen {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border: 1px solid #E5E7EB;
        }

        /* Custom Button Styling (Primary Action - Red/Green) */
        .btn-primary {
            background-color: var(--primary-red);
            color: white;
            padding: 1rem 2rem;
            font-size: 1.25rem;
            font-weight: 700;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px var(--danger-red); 
        }
        .btn-primary:hover {
            filter: brightness(1.1);
        }
        .btn-primary:active {
            box-shadow: 0 1px var(--danger-red);
            transform: translateY(3px);
        }

        /* Secondary/Navigation Button Styling */
        .btn-secondary {
            background-color: #3C3C3C; 
            color: var(--text-light);
            padding: 1rem 2rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-radius: 0.75rem;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px #222222;
        }
        body.light-mode .btn-secondary {
            background-color: #E5E7EB; 
            color: var(--text-light);
            box-shadow: 0 4px #D1D5DB;
        }
        .btn-secondary:hover {
            background-color: #4A4A4A;
        }
        body.light-mode .btn-secondary:hover {
            background-color: #D1D5DB;
        }
        .btn-secondary:active {
            box-shadow: 0 1px #222222;
            transform: translateY(3px);
        }
        body.light-mode .btn-secondary:active {
            box-shadow: 0 1px #D1D5DB;
        }

        /* Options/Phrase Button Styling */
        .option-btn {
            background-color: #222222;
            color: var(--text-light);
            padding: 1.5rem;
            min-height: 120px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, border 0.2s;
            border: 3px solid #444444; /* Initial dark border */
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        body.light-mode .option-btn {
            background-color: #F9FAFB;
            border: 3px solid #D1D5DB; 
            color: var(--text-light);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .option-btn:hover {
            border-color: #666666;
        }
        body.light-mode .option-btn:hover {
            border-color: #A0AEC0;
        }
        /* ADDED FOCUS STATE FOR ACCESSIBILITY */
        .option-btn:focus, .btn-primary:focus, .btn-secondary:focus {
            outline: 3px solid var(--primary-red);
            outline-offset: 2px;
        }
        .option-btn .phrase-main {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }
        .option-btn .phrase-sub {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Feedback Styles */
        .option-btn.correct {
            background-color: var(--success-green) !important; 
            border-color: #276749 !important;
            color: white !important;
            animation: pulse-green 0.5s 3;
        }
        .option-btn.incorrect {
            background-color: var(--danger-red) !important;
            border-color: #9B2C2C !important;
            color: white !important;
        }

        /* Destination Card Styling */
        .dest-card {
            background-color: #222222;
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        body.light-mode .dest-card {
            background-color: #F3F4F6;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .dest-card:hover:not([disabled]) {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }
        body.light-mode .dest-card:hover:not([disabled]) {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .dest-card-code {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 0.25rem;
        }
        .dest-card.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .dest-card.active-dest {
            border: 3px solid var(--primary-red);
        }

        /* --- NEW CSS for 1:1 Aspect Ratio on Badges --- */
        .badge-square-wrapper {
            /* This div enforces the square aspect ratio based on width */
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* Makes height equal to width */
        }
        .badge-grid-content {
            /* This div contains the actual badge visuals and sits perfectly inside the wrapper */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Inherit base dest-card styles, but remove conflicting height/padding */
            background-color: #222222;
            border-radius: 0.75rem;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.5rem; /* Reduced padding for smaller content */
            border: 2px solid; /* Added for visual separation */
        }
        body.light-mode .badge-grid-content {
            background-color: #F3F4F6;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* NEW: Badge Row Header */
        .badge-row-header {
            grid-column: span 5; /* Span across all 5 columns */
            text-align: left;
            padding-top: 1rem;
            padding-bottom: 0.5rem;
            margin-top: 0.5rem;
            font-size: 1.5rem;
            font-weight: 800;
            border-bottom: 2px solid var(--text-secondary);
            color: var(--text-light);
        }
        
        /* Modal Animation */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(56, 161, 105, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(56, 161, 105, 0); }
            100% { box-shadow: 0 0 0 0 rgba(56, 161, 105, 0); }
        }

        /* Settings Toggle Switch (General) */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-red);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-red);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }
        
        /* New Floating Nav Style */
        .quick-access-btn {
            background-color: #4A4A4A;
            color: var(--text-light);
            padding: 1rem;
            font-size: 1.5rem;
            border-radius: 50%;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        body.light-mode .quick-access-btn {
            background-color: #E5E7EB;
            color: #1A1A1A;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .quick-access-btn:hover {
            background-color: #666666;
            transform: scale(1.05);
        }
        body.light-mode .quick-access-btn:hover {
            background-color: #D1D5DB;
        }

        /* --- FIREBASE SECRETS BLUR/VISIBILITY STYLES (Kept for Profile ID) --- */
        .blurred {
            filter: blur(4px);
            transition: filter 0.3s;
        }
        .visible {
            filter: blur(0);
        }
    </style>
</head>
<body class="dark-mode"> <div id="app" class="text-center p-4">
        <p id="authStatus" class="text-sm text-gray-400 mb-2 hidden"></p> 
        <div id="gameScreens">
            
            <div id="titlePage" class="game-screen">
                <h1 class="text-7xl font-black mb-2 text-red-500 tracking-wide">GTA</h1>
                <h2 class="text-3xl font-light mb-4" style="color: var(--text-secondary)">Global Translation Adventures</h2>
                
                <h3 id="travelerGreeting" class="text-4xl font-bold mb-8" style="color: var(--text-light)">Welcome, Traveler!</h3>
                
                <p class="mb-12 max-w-lg mx-auto" style="color: var(--text-secondary)">Your language journey awaits across 6 countries and 30 thrilling adventures.</p>
                
                <div class="space-y-4 max-w-sm mx-auto">
                    <button id="startButton" class="btn-primary w-full"><i class="fas fa-play mr-2"></i> Start Your Journey</button>
                    <button id="profileButton" class="btn-secondary w-full"><i class="fas fa-user-circle mr-2"></i> Profile</button>
                    <button id="progressButton" class="btn-secondary w-full"><i class="fas fa-chart-line mr-2"></i> Progress Tracker</button>
                    <button id="settingsButton" class="btn-secondary w-full"><i class="fas fa-cog mr-2"></i> Settings</button>
                </div>
            </div>

            <div id="destinationScreen" class="game-screen hidden">
                <div class="text-left mb-6">
                    <button class="text-lg hover:text-red-500" data-target="titlePage" style="color: var(--text-secondary)">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Title Screen
                    </button>
                </div>
                
                <h2 class="text-4xl font-bold mb-2 text-red-500 text-left">Select Your Destination</h2>
                <p class="mb-8 text-left" style="color: var(--text-secondary)">Master a country's adventures to unlock the next destination and earn a rank up!</p>
                
                <div id="destinationList" class="grid grid-cols-2 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                    </div>
            </div>

            <div id="adventureScreen" class="game-screen hidden">
                <div class="flex justify-between items-center mb-6 text-lg">
                    <button class="hover:text-red-500" data-target="destinationScreen" style="color: var(--text-secondary)">
                            <i class="fas fa-arrow-left mr-2"></i> Back to Country Selection
                    </button>
                    <button id="viewProgressButton" class="text-green-500 hover:text-green-400" data-target="progressScreen">
                        View Progress Tracker <i class="fas fa-angle-right ml-1"></i>
                    </button>
                </div>
                
                <h2 id="adventureTitle" class="text-4xl font-bold mb-8 text-yellow-400 text-left">Destination: Japan (Traveler Rank)</h2>
                
                <div id="adventureList" class="space-y-4 max-w-4xl mx-auto text-left">
                    </div>
            </div>

            <div id="gameScene" class="game-screen hidden">
                <div class="text-left mb-6">
                    <button class="text-lg hover:text-red-500" data-target="adventureScreen" style="color: var(--text-secondary)">
                        <i class="fas fa-arrow-left mr-2"></i> Exit Scenario
                    </button>
                </div>

                <h3 id="sceneAdventureName" class="text-3xl font-bold mb-1 text-yellow-400 text-left">Tokyo Arrival: Check-In & Transport</h3>
                <h4 id="sceneHeader" class="text-base mb-6 text-left" style="color: var(--text-secondary)">Country: Japan | Adventure 1</h4>
                
                <p id="scenePrompt" class="text-xl font-medium mb-6 text-left" style="color: var(--text-light)">You've just landed in Tokyo and need to find your luggage. What do you say to the airport staff?</p>
                
                <div id="sceneContainer" class="max-w-4xl mx-auto p-6 rounded-xl shadow-2xl border-4" style="background-color: var(--background-deep); border-color: var(--text-secondary)">
                    <img id="sceneImage" src="" alt="Current Scene" class="w-full h-auto rounded-lg mb-6 border-2" style="border-color: var(--text-secondary)">
                    
                    <div id="optionsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        </div>
                </div>
                
                <div id="translationDisplayContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-4xl mx-auto mt-2 min-h-[50px]">
                    </div>

                <div id="feedbackMessage" class="mt-6 text-2xl font-bold transition-opacity duration-300 opacity-0 min-h-[40px]"></div>
                
                <button id="continueButton" class="btn-primary w-full max-w-lg mt-6 hidden" onclick="nextScene()" style="background-color: var(--primary-red); box-shadow: 0 4px var(--danger-red);">
                    Continue Touring (1/5 Scenes)
                </button>

                <button id="completeAdventureButton" class="btn-primary w-full max-w-lg mt-6 hidden" onclick="completeAdventure()" style="background-color: var(--success-green); box-shadow: 0 4px #276749;">
                    COMPLETE ADVENTURE AND EARN BADGE
                </button>
            </div>
            
            <div id="progressScreen" class="game-screen hidden">
                <div class="text-left mb-6">
                    <button class="text-lg hover:text-red-500" data-target="titlePage" style="color: var(--text-secondary)">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Title Screen
                    </button>
                </div>
                
                <div class="p-6 rounded-lg mb-8 shadow-inner border-t-4 border-b-4 border-red-500" style="background-color: var(--background-deep)">
                    <div class="flex justify-between items-center">
                        <h3 class="text-4xl font-extrabold" id="rankCountryName" style="color: var(--text-light)">Japan (Traveler)</h3>
                        <span class="text-6xl font-black text-red-500" id="rankCountryCode">JP</span>
                    </div>
                    <p class="text-sm font-light mb-2" style="color: var(--text-secondary)">Traveler ID: <span id="progressUserId" class="font-mono text-xs text-yellow-400">Loading...</span></p>
                    <div class="text-lg font-semibold text-green-500 mt-4">
                        <span id="adventuresCompleted">0</span> / 5 Adventures Completed
                    </div>
                    <div class="text-sm mt-2" style="color: var(--text-secondary)">
                        Next Rank: France (Globetrotter)
                    </div>
                </div>
                
                <h3 class="text-2xl font-bold mb-6 text-left" style="color: var(--text-light)">All 30 Badges Earned</h3>
                
                <div id="badgeContainer" class="grid grid-cols-5 gap-3 p-4 rounded-lg max-w-4xl mx-auto border h-96 overflow-y-auto" style="background-color: var(--background-deep); border-color: var(--text-secondary)">
                    </div>
            </div>

            <div id="settingsScreen" class="game-screen hidden">
                <h2 class="text-4xl font-bold mb-8">Settings</h2>
                <div class="max-w-xl mx-auto space-y-6">

                    <div class="flex justify-between items-center p-4 rounded-lg border" style="background-color: var(--background-deep); border-color: var(--text-secondary)">
                        <span class="text-xl font-medium" style="color: var(--text-light)">Light / Dark Mode</span>
                        <label class="switch">
                            <input type="checkbox" id="themeToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="p-4 rounded-lg border" style="background-color: var(--background-deep); border-color: var(--text-secondary)">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xl font-medium" style="color: var(--text-light)">Background Music</span>
                            <label class="switch">
                                <input type="checkbox" id="musicMuteToggle">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <input type="range" id="musicVolume" min="0" max="1" value="0.5" step="0.1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                    </div>

                    <div class="p-4 rounded-lg border" style="background-color: var(--background-deep); border-color: var(--text-secondary)">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xl font-medium" style="color: var(--text-light)">Audio Pronunciation Volume</span>
                             <label class="switch">
                                <input type="checkbox" id="audioMuteToggle">
                            <span class="slider round"></span>
                            </label>
                        </div>
                        <input type="range" id="audioVolume" min="0" max="1" value="1.0" step="0.1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                    </div>

                </div>
                <button class="btn-secondary mt-12" data-target="titlePage"><i class="fas fa-arrow-left mr-2"></i> Back to Title</button>
            </div>

             <div id="profileScreen" class="game-screen hidden">
                 <h2 class="text-4xl font-bold mb-8">Traveler Profile</h2>
                <div class="max-w-sm mx-auto space-y-4">
                    <div class="text-lg font-light mb-4">
                        <p style="color: var(--text-light)">User ID: <span id="profileUserId" class="font-mono text-sm text-yellow-400">Loading...</span></p>
                    </div>
                    <input type="text" id="travelerNameInput" placeholder="Traveler Name" class="w-full p-3 rounded text-white placeholder-gray-400 border border-gray-700 focus:border-red-500 focus:ring-red-500" style="background-color: var(--background-deep)">
                    <input type="email" id="emailInput" placeholder="Email stay up to date for future releases" class="w-full p-3 rounded text-white placeholder-gray-400 border border-gray-700 focus:border-red-500 focus:ring-red-500" style="background-color: var(--background-deep)">
                    <button id="saveProfileButton" class="btn-primary w-full bg-green-600 hover:bg-green-500 shadow-green-700">Save Profile</button>
                </div>
                
                <button class="btn-secondary mt-12" data-target="titlePage"><i class="fas fa-arrow-left mr-2"></i> Back to Title</button>
            </div>


            <div id="badgeModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
                <div class="p-10 rounded-xl shadow-2xl text-center max-w-md w-11/12 transform transition-transform duration-300 scale-100 border-t-8 border-yellow-500" style="background-color: var(--card-dark); color: var(--text-light)">
                    <i class="fas fa-trophy text-7xl text-yellow-500 mb-6 animate-bounce"></i>
                    <h3 class="text-4xl font-extrabold mb-2 text-red-400">Adventure Complete!</h3>
                    <p class="text-xl font-semibold mb-4">You earned the <span id="modalBadgeName" class="text-yellow-400"></span>!</p>
                    <p id="modalLevelMessage" class="text-lg mb-8 font-light"></p>
                    <button id="closeBadgeModal" class="btn-primary bg-red-500 hover:bg-red-400 shadow-red-700">Continue</button>
                </div>
            </div>

        </div>
    </div>
    
    <div id="quickAccessNav" class="fixed bottom-4 right-4 space-y-3 flex flex-col hidden z-40">
        <button id="quickSettingsButton" class="quick-access-btn" data-target="settingsScreen">
            <i class="fas fa-cog"></i>
        </button>
        <button id="quickHomeButton" class="quick-access-btn" data-target="titlePage">
            <i class="fas fa-home"></i>
        </button>
    </div>

    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Set Firebase Log Level to Debug
        setLogLevel('Debug');

        // Global Firebase variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // --- START USER MODIFICATION ZONE ---
        const userFirebaseConfig = {
            "apiKey": "AIzaSyBiHrqtWWI7VhfJhWWy8DonXSUWLXOiJCA",
            "authDomain": "gta-web-app-5abcd.firebaseapp.com",
            "projectId": "gta-web-app-5abcd",
            "storageBucket": "gta-web-app-5abcd.firebasestorage.app",
            "messagingSenderId": "135809506245",
            "appId": "1:135809506245:web:9c7f5848f9a931f53d49ac"
        }; 
        // --- END USER MODIFICATION ZONE ---
        
        // This handles both the environment config (if available) or the user's manual config
        const firebaseConfig = Object.keys(userFirebaseConfig).length > 0 ? userFirebaseConfig : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {});
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let userProgress = {}; // Stores all game state: { badges: [], profile: {}, settings: {} }
        
        // --- AUDIO PLAYERS ---
        const BACKGROUND_MUSIC_URL = './audio/petals-on-the-water-full-version-japanese-fusion-lofi-392739.mp3';
        const backgroundMusic = new Audio(BACKGROUND_MUSIC_URL);
        backgroundMusic.loop = true;
        backgroundMusic.volume = 0; 
        
        let currentAudioPlayer = null; 

        // --- GAME DATA STRUCTURE (The Core Content) ---
        // UPDATED: All countries now have 5 placeholder adventures for the 6x5 grid
        const GAME_DATA = {
            japan: {
                name: "Japan",
                code: "JP",
                language: "Japanese",
                requiredBadges: 0, // Starts unlocked
                color: "text-red-500", // Tailwind class for text color
                adventures: [
                    {
                        id: "discovery",
                        name: "Discovery",
                        badgeName: "Sakura Badge",
                        rank: "Traveler",
                        scenes: [
                            // Scene 1: direction to baggage (Correct: 荷物はどこですか？)
                            {
                                image: "https://i.imgur.com/TzGpTBn.jpeg",
                                prompt: "You've just landed in Tokyo and need to find your luggage. What do you say to the airport staff?",
                                options: [
                                    { phrase: "これはいくらですか？", romanization: "Kore wa ikura desu ka?", translation: "How much is this?", audio: "ikura.mp3", isCorrect: false },
                                    { phrase: "荷物はどこですか？", romanization: "Nimotsu wa doko desu ka?", translation: "Where is the baggage?", audio: "nimotsu.mpp3", isCorrect: true },
                                    { phrase: "トイレはどこですか？", romanization: "Toire wa doko desu ka?", translation: "Where is the toilet?", audio: "taxistand.mp3", isCorrect: false }
                                ]
                            },
                            // Scene 2: direction to hotel (Correct: ホテルまでお願いします)
                            {
                                image: "https://i.imgur.com/dYv5NiI.jpeg",
                                prompt: "You're at the taxi stand. Tell the driver you need to go to the hotel.",
                                options: [
                                    { phrase: "荷物はどこですか？", romanization: "Nimotsu wa doko desu ka?", translation: "Where is the baggage?", audio: "nimotsu.mp3", isCorrect: false },
                                    { phrase: "タクシー乗り場は？", romanization: "Takushii noriba wa?", translation: "Where is the taxi stand?", audio: "taxistand.mp3", isCorrect: false },
                                    { phrase: "ホテルまでお願いします。", romanization: "Hoteru made onegaishimasu.", translation: "Please take me to my hotel.", audio: "hoteru.mp3", isCorrect: true }
                                ]
                            },
                            // Scene 3: check in (Correct: チェックインをお願いします)
                            {
                                image: "https://i.imgur.com/7O21k67.jpeg",
                                prompt: "You've arrived! Tell the front desk you are here to check in.",
                                options: [
                                    { phrase: "いくらですか？", romanization: "Ikura desu ka?", translation: "How much is this?", audio: "ikura.mp3", isCorrect: false },
                                    { phrase: "チェックインをお願いします。", romanization: "Chekkuin o onegaishimasu.", translation: "I am here to check in.", audio: "checkin.mp3", isCorrect: true },
                                    { phrase: "予約があります。", romanization: "Yoyaku ga arimasu.", translation: "I have a reservation.", audio: "reservation.mp3", isCorrect: false }
                                ]
                            },
                            // Scene 4: I am hungry (Correct: お腹が空きました)
                            {
                                image: "https://i.imgur.com/W1oNh8L.jpeg",
                                prompt: "You are finally in your room, but you're starving. Tell the concierge you are hungry.",
                                options: [
                                    { phrase: "レストランは？", romanization: "Resutoran wa?", translation: "Where is the restaurant?", audio: "restaurant.mp3", isCorrect: false },
                                    { phrase: "お腹が空きました。", romanization: "Onaka ga sukimashita.", translation: "I am hungry.", audio: "hungry.mp3", isCorrect: true },
                                    { phrase: "チェックをお願いします。", romanization: "Chekku o onegaishimasu.", translation: "Check, please.", audio: "checkplease.mp3", isCorrect: false }
                                ]
                            },
                            // Scene 5: I want ramen (Correct: ラーメンをお願いします)
                            {
                                image: "https://i.imgur.com/xHASNyg.jpeg",
                                prompt: "You found a ramen shop! Order a bowl of ramen.",
                                options: [
                                    { phrase: "ラーメンをお願いします。", romanization: "Raamen o onegaishimasu.", translation: "Ramen, please.", audio: "ramen.mp3", isCorrect: true },
                                    { phrase: "元気ですか？", romanization: "Genki desu ka?", translation: "How are you?", audio: "genki.mp3", isCorrect: false },
                                    { phrase: "いくらですか？", romanization: "Ikura desu ka?", translation: "How much is this?", audio: "ikura.mp3", isCorrect: false }
                                ]
                            },
                        ]
                    },
                    // Remaining Japan adventures
                    { id: "exploration", name: "Exploration", badgeName: "Fuji Badge", rank: "Explorer", scenes: [] },
                    { id: "challenge", name: "Challenge", badgeName: "Samurai Badge", rank: "Challenger", scenes: [] },
                    { id: "expedition", name: "Expedition", badgeName: "Ninja Badge", rank: "Expeditionist", scenes: [] },
                    { id: "summit", name: "Summit", badgeName: "Mastery Badge", rank: "Master", scenes: [] },
                ]
            },
            italy: { 
                name: "Italy", 
                code: "IT", 
                language: "Italian", 
                requiredBadges: 5, // Requires all 5 Japan badges
                color: "text-green-500", 
                adventures: [
                    // Added 5 placeholder adventures for Italy to support sequential badge tracking
                    { id: "pasta", name: "Pasta Discovery", badgeName: "Roman Badge", rank: "Globetrotter", scenes: [] },
                    { id: "coffee", name: "Morning Coffee", badgeName: "Espresso Badge", rank: "Globetrotter", scenes: [] },
                    { id: "art", name: "Art Tour", badgeName: "Renaissance Badge", rank: "Globetrotter", scenes: [] },
                    { id: "venice", name: "Venice Waters", badgeName: "Gondola Badge", rank: "Globetrotter", scenes: [] },
                    { id: "etna", name: "Volcano Climb", badgeName: "Lava Badge", rank: "Globetrotter", scenes: [] },
                ]
            },
            france: { 
                name: "France", 
                code: "FR", 
                language: "French", 
                requiredBadges: 10, // Requires 10 badges
                color: "text-blue-500", 
                adventures: [
                    { id: "paris", name: "Paris Arrival", badgeName: "Eiffel Badge", rank: "Connoisseur", scenes: [] },
                    { id: "wine", name: "Vineyard Visit", badgeName: "Bordeaux Badge", rank: "Connoisseur", scenes: [] },
                    { id: "art", name: "Louvre", badgeName: "Monet Badge", rank: "Connoisseur", scenes: [] },
                    { id: "food", name: "Fine Dining", badgeName: "Baguette Badge", rank: "Connoisseur", scenes: [] },
                    { id: "cannes", name: "Film Festival", badgeName: "Cannes Badge", rank: "Connoisseur", scenes: [] },
                ] 
            },
            mexico: { 
                name: "Mexico", 
                code: "MX", 
                language: "Spanish", 
                requiredBadges: 15, // Requires 15 badges
                color: "text-yellow-500", 
                adventures: [
                    { id: "cdmx", name: "City Arrival", badgeName: "Aztec Badge", rank: "Advocate", scenes: [] },
                    { id: "tacos", name: "Street Food", badgeName: "Taco Badge", rank: "Advocate", scenes: [] },
                    { id: "pyramid", name: "Ancient Ruins", badgeName: "Teotihuacan Badge", rank: "Advocate", scenes: [] },
                    { id: "beach", name: "Coastal Trip", badgeName: "Cozumel Badge", rank: "Advocate", scenes: [] },
                    { id: "market", name: "Local Market", badgeName: "Chili Badge", rank: "Advocate", scenes: [] },
                ] 
            },
            germany: { 
                name: "Germany", 
                code: "DE", 
                language: "German", 
                requiredBadges: 20, // Requires 20 badges
                color: "text-indigo-500", 
                adventures: [
                    { id: "berlin", name: "Capital City", badgeName: "Wall Badge", rank: "Patriot", scenes: [] },
                    { id: "beer", name: "Brewery Tour", badgeName: "Oktoberfest Badge", rank: "Patriot", scenes: [] },
                    { id: "car", name: "Autobahn Drive", badgeName: "Turbo Badge", rank: "Patriot", scenes: [] },
                    { id: "castle", name: "Bavarian Castle", badgeName: "Neuschwanstein Badge", rank: "Patriot", scenes: [] },
                    { id: "river", name: "Rhine Cruise", badgeName: "Rhine Badge", rank: "Patriot", scenes: [] },
                ] 
            },
            korean: { 
                name: "Korean", 
                code: "KR", 
                language: "Korean", 
                requiredBadges: 25, // Requires 25 badges
                color: "text-pink-500", 
                adventures: [
                    { id: "seoul", name: "Seoul City", badgeName: "Hallyu Badge", rank: "Master", scenes: [] },
                    { id: "kfood", name: "Street Food", badgeName: "Kimchi Badge", rank: "Master", scenes: [] },
                    { id: "tech", name: "Tech District", badgeName: "Samsung Badge", rank: "Master", scenes: [] },
                    { id: "temple", name: "Mountain Temple", badgeName: "Dharma Badge", rank: "Master", scenes: [] },
                    { id: "kpop", name: "Music Show", badgeName: "Idol Badge", rank: "Master", scenes: [] },
                ] 
            },
        };
        
        const audioPath = (filename) => `./audio/${filename}`; 
        
        let currentDestinationId = 'japan';
        let currentAdventureIndex = 0;
        let currentSceneIndex = 0;
        let correctOption = null;
        let isProcessing = false;
        let isReviewMode = false; // Tracks if the current session is a review
        
        // --- UI Elements ---
        const quickAccessNav = document.getElementById('quickAccessNav');

        // --- FIREBASE AND AUTHENTICATION SETUP (Using existing boilerplate) ---

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config is missing. Running in local mode without persistent progress saving.");
                    document.getElementById('authStatus').textContent = `Data Persistence: Disabled (Local Mode)`;
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const authStatusEl = document.getElementById('authStatus');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `Signed in as: ${user.uid.substring(0, 8)}...`;
                        await loadUserProgress();
                    } else {
                        // If we have custom config (meaning it's the live app), sign in anonymously.
                        if (Object.keys(userFirebaseConfig).length > 0) {
                            await signInAnonymously(auth);
                        } else if (!initialAuthToken) {
                            // If running in environment but without initial token, fallback to anonymous
                            await signInAnonymously(auth);
                        }
                    }
                });

                if (initialAuthToken && Object.keys(userFirebaseConfig).length === 0) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('authStatus').textContent = `Authentication Error: ${error.message}`;
            }
        }

        const getProgressDocRef = (uid) => doc(db, `artifacts/${appId}/users/${uid}/progress`, 'gta_progress');

        async function loadUserProgress() {
            if (!db) return; 

            const progressRef = getProgressDocRef(userId);

            onSnapshot(progressRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProgress = docSnap.data();
                } else {
                    userProgress = {
                        badges: [], // e.g., ["japan-discovery"]
                        profile: { name: "Traveler", email: "" },
                        settings: { theme: 'dark-mode', musicVolume: 0.2, audioVolume: 1.0, musicMuted: false, audioMuted: false }, 
                    };
                    saveUserProgress(); 
                }
                renderUI();
            }, (error) => {
                console.error("Error listening to progress:", error);
            });
        }

        async function saveUserProgress() {
            if (!userId || !db) {
                console.warn("Cannot save progress: User not authenticated or Firebase disabled.");
                return;
            }
            const progressRef = getProgressDocRef(userId);
            try {
                await setDoc(progressRef, userProgress, { merge: true });
            } catch (error) {
                console.error("Error saving progress:", error);
            }
        }
        
        // --- SCREEN NAVIGATION ---

        function switchScreen(targetId) {
            const screens = document.querySelectorAll('.game-screen');
            screens.forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(targetId).classList.remove('hidden');

            // Control Quick Access Nav visibility
            if (targetId === 'titlePage') {
                quickAccessNav.classList.add('hidden');
            } else {
                quickAccessNav.classList.remove('hidden');
            }

            if (targetId === 'destinationScreen') {
                renderDestinationScreen();
            } else if (targetId === 'progressScreen') {
                renderProgressTracker();
            } else if (targetId === 'settingsScreen') {
                applySettings(); 
            } else if (targetId === 'profileScreen') {
                 renderProfileScreen();
            }
        }

        // --- GAME LOGIC (Using existing boilerplate) ---

        function renderDestinationScreen() {
            const listEl = document.getElementById('destinationList');
            listEl.innerHTML = '';
            
            // Calculate current total badges for unlocking logic
            const totalBadgesEarned = userProgress.badges.length;

            Object.entries(GAME_DATA).forEach(([id, dest]) => {
                // Determine if this country is locked
                const isLocked = totalBadgesEarned < dest.requiredBadges; 

                // Placeholder rank for UI display
                const currentRank = dest.adventures[0] ? dest.adventures[0].rank : "Traveler";

                const button = document.createElement('button');
                button.dataset.dest = id;
                button.classList = `dest-card text-white ${dest.color}`;

                const code = `<div class="dest-card-code ${dest.color}">${dest.code}</div>`;
                const name = `<div class="text-xl font-bold">${dest.name}</div>`;
                let status = '';

                if (isLocked) {
                    button.classList.add('locked');
                    button.disabled = true;
                    // Display unlock requirement
                    status = `<div class="text-xs font-semibold text-gray-500 mt-1">LOCKED (${dest.requiredBadges} Badges)</div>`;
                } else {
                    // Unlocked country styling
                    button.classList.remove('locked');
                    button.disabled = false;
                    button.classList.add('active-dest');
                    button.onclick = () => renderAdventureScreen(id);
                    status = `<div class="text-xs font-semibold text-green-400 mt-1">${currentRank} Rank</div>`; 
                }

                button.innerHTML = `${code}${name}${status}`;
                listEl.appendChild(button);
            });
        }

        // Updated: Renders Review button if completed
        function renderAdventureScreen(destId) {
            currentDestinationId = destId;
            const destData = GAME_DATA[destId];
            const currentRank = destData.adventures[0] ? destData.adventures[0].rank : "Traveler";

            document.getElementById('adventureTitle').innerHTML = 
                `<span class="text-yellow-400">Destination: ${destData.name}</span> (${currentRank} Rank)`;

            const listEl = document.getElementById('adventureList');
            listEl.innerHTML = '';
            
            let previousAdventureCompleted = true; // Tracks sequential completion for locking

            destData.adventures.forEach((adventure, index) => {
                const adventureId = `${destId}-${adventure.id}`;
                const isCompleted = userProgress.badges.includes(adventureId);
                const isLocked = !previousAdventureCompleted && !isCompleted;
                
                const listItem = document.createElement('div');
                listItem.classList = 'p-4 flex justify-between items-center rounded-lg';
                
                if (isCompleted) {
                    // *** REVIEW MODE LOGIC (Allows Revisit) ***
                    listItem.classList.add('bg-green-800', 'text-white', 'border', 'border-green-600');
                    
                    const hasContent = adventure.scenes && adventure.scenes.length > 0;

                    listItem.innerHTML = `
                        <div class="font-bold">${adventure.name}</div>
                        <div>
                            <span class="text-sm font-semibold text-green-300 mr-4">
                                <i class="fas fa-check-circle mr-1"></i> Completed
                            </span>
                            <button class="btn-secondary py-2 px-4 text-base shadow-none ${hasContent ? 'bg-green-600 hover:bg-green-700' : 'bg-yellow-600 hover:bg-yellow-700'} text-white" 
                                    onclick="startAdventure(${index})">
                                ${hasContent ? 'Review' : 'Under Construction'}
                            </button>
                        </div>
                    `;

                } else if (isLocked) {
                    listItem.classList.add('bg-gray-700', 'text-gray-400');
                    listItem.innerHTML = `
                        <div class="font-bold">${adventure.name}</div>
                        <div class="text-sm">Locked: Complete previous adventure first</div>
                    `;
                } else {
                    // This adventure is unlocked/available
                    const hasContent = adventure.scenes && adventure.scenes.length > 0;
                    
                    listItem.classList.add('bg-gray-800', 'text-white', 'border', 'border-gray-700');
                    
                    if (hasContent) {
                        // Adventure has content and is ready to start
                        listItem.innerHTML = `
                            <div class="font-bold">${adventure.name}</div>
                            <button class="btn-primary py-2 px-4 text-base shadow-none" onclick="startAdventure(${index})">
                                Start Adventure
                            </button>
                        `;
                    } else {
                        // Adventure is unlocked but has no content (Under Construction)
                        listItem.innerHTML = `
                            <div class="font-bold">${adventure.name}</div>
                            <button class="btn-secondary py-2 px-4 text-base shadow-none bg-yellow-600 hover:bg-yellow-700 text-white" onclick="startAdventure(${index})">
                                Under Construction
                            </button>
                        `;
                    }
                }
                
                if (!isCompleted) {
                    previousAdventureCompleted = false; // Next adventure is locked if this one isn't done
                }

                listEl.appendChild(listItem);
            });
            switchScreen('adventureScreen');
        }

        // Updated: Sets isReviewMode state
        function startAdventure(adventureIndex) {
            currentAdventureIndex = adventureIndex;
            const dest = GAME_DATA[currentDestinationId];
            const adventure = dest.adventures[currentAdventureIndex];
            const adventureId = `${currentDestinationId}-${adventure.id}`; 
            
            // Set the review mode based on current progress
            isReviewMode = userProgress.badges.includes(adventureId);

            // CHECK 1: If the adventure has no content, show the message.
            if (!adventure.scenes || adventure.scenes.length === 0) {
                 document.getElementById('modalBadgeName').textContent = adventure.name;
                 document.getElementById('modalLevelMessage').textContent = "This adventure is currently under construction. Please check back soon!";
                 
                 const modalButton = document.getElementById('closeBadgeModal');
                 modalButton.textContent = "Close";
                 modalButton.classList.remove('bg-red-500', 'shadow-red-700');
                 modalButton.classList.add('bg-gray-500', 'hover:bg-gray-600', 'shadow-gray-700');

                 document.getElementById('badgeModal').classList.remove('hidden');
                 return;
            }

            // CHECK 2: If the adventure has content, start the game.
            currentSceneIndex = 0;
            switchScreen('gameScene');
            renderScene();
        }
        
        function renderScene() {
            const dest = GAME_DATA[currentDestinationId];
            const adventure = dest.adventures[currentAdventureIndex];
            const scene = adventure.scenes[currentSceneIndex];
            
            // Update Headers 
            document.getElementById('sceneAdventureName').textContent = `${adventure.name} Scenario`;
            document.getElementById('sceneHeader').textContent = `Country: ${dest.name} | Adventure ${currentAdventureIndex + 1}`;
            document.getElementById('sceneImage').src = scene.image;
            document.getElementById('sceneImage').onerror = () => document.getElementById('sceneImage').src = 'https://placehold.co/600x400/222222/F9FAFB?text=Image+Not+Found';
            document.getElementById('scenePrompt').textContent = scene.prompt;
            
            // Hide all buttons initially
            document.getElementById('continueButton').classList.add('hidden');
            document.getElementById('completeAdventureButton').classList.add('hidden');
            
            const optionsEl = document.getElementById('optionsContainer');
            optionsEl.innerHTML = '';

            const translationDisplayEl = document.getElementById('translationDisplayContainer');
            translationDisplayEl.innerHTML = ''; 
            
            scene.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.classList = 'option-btn';
                
                // --- PHRASE CARD CONTENT: PHRASE AND ROMANIZATION ONLY ---
                button.innerHTML = `
                    <div class="phrase-main">${option.phrase}</div>
                    <div class="phrase-sub">${option.romanization}</div>
                `;
                // Store data needed for checkAnswer in the button's dataset
                button.dataset.index = index;
                button.dataset.isCorrect = option.isCorrect;
                button.dataset.translation = option.translation; 
                
                // Hover for Audio Pronunciation
                button.addEventListener('mouseenter', () => playAudio(audioPath(option.audio)));

                // Click to Check Answer
                button.addEventListener('click', (e) => checkAnswer(e.currentTarget, option.isCorrect));

                optionsEl.appendChild(button);

                // --- CREATE SEPARATE TRANSLATION DISPLAY ELEMENT BELOW ---
                const translationEl = document.createElement('div');
                translationEl.classList.add('text-center', 'text-lg', 'font-bold', 'opacity-0', 'transition-opacity', 'duration-500');
                translationEl.dataset.index = index;
                translationEl.id = `translation-${index}`;
                translationDisplayEl.appendChild(translationEl);
            });
            correctOption = scene.options.find(opt => opt.isCorrect);
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = false);
            isProcessing = false;
        }
        
        function nextScene() {
             const dest = GAME_DATA[currentDestinationId];
             const adventure = dest.adventures[currentAdventureIndex];
             
             // Defensive check against rapid clicking
             if (isProcessing) return; 

             currentSceneIndex++;
             if (currentSceneIndex < adventure.scenes.length) {
                 // Move to next scene
                 document.getElementById('continueButton').textContent = `Continue Touring (${currentSceneIndex + 1}/${adventure.scenes.length} Scenes)`;
                 renderScene();
             } else {
                 // Last scene, show complete button
                 document.getElementById('continueButton').classList.add('hidden');
                 document.getElementById('completeAdventureButton').classList.remove('hidden');
             }
        }

        function playAudio(path) {
            const audioSettings = userProgress.settings || { audioVolume: 1.0, audioMuted: false };
            if (audioSettings.audioMuted) return;

            if (currentAudioPlayer && !currentAudioPlayer.paused) {
                currentAudioPlayer.pause();
                currentAudioPlayer.currentTime = 0;
            }

            const audio = new Audio(path);
            audio.volume = audioSettings.audioVolume;
            currentAudioPlayer = audio;

            audio.play().catch(e => console.warn("Audio playback failed (file not found or user gesture required):", e));
        }
        
        // --- BACKGROUND MUSIC CONTROL ---
        function setBackgroundMusicState(volume, isMuted) {
            backgroundMusic.volume = isMuted ? 0 : volume;
            if (backgroundMusic.paused) {
                if (!isMuted) {
                    backgroundMusic.play().catch(e => console.log("Music auto-play prevented by browser. User must interact first.", e));
                }
            } else {
                if (isMuted) {
                    backgroundMusic.volume = 0;
                } else {
                     backgroundMusic.volume = volume;
                }
            }
        }

        function attemptMusicPlay() {
            const settings = userProgress.settings || { musicVolume: 0.0, musicMuted: true };
            if (settings.musicMuted || !backgroundMusic.paused) return;

            backgroundMusic.volume = settings.musicVolume;
            backgroundMusic.play()
                .then(() => {
                    console.log("Background music started successfully.");
                })
                .catch(e => {
                    console.warn("Music play blocked, retrying in 500ms. Error:", e);
                    setTimeout(() => {
                         backgroundMusic.play().catch(e => console.warn("Music play failed after retry.", e));
                    }, 500);
                });
        }

        function showFeedback(message, type) {
            const feedbackEl = document.getElementById('feedbackMessage');
            feedbackEl.textContent = message;
            feedbackEl.classList.remove('text-green-400', 'text-red-400', 'opacity-0');
            feedbackEl.classList.add(type === 'correct' ? 'text-green-400' : 'text-red-400');
            
            setTimeout(() => feedbackEl.classList.remove('opacity-0'), 10);
            setTimeout(() => feedbackEl.classList.add('opacity-0'), 1500);
        }
        
        function revealTranslation(button) {
            const index = button.dataset.index;
            const translation = button.dataset.translation;
            const translationEl = document.getElementById(`translation-${index}`);
            
            if (translationEl) {
                translationEl.textContent = translation;
                translationEl.classList.remove('opacity-0'); // Make visible
                translationEl.classList.add('text-yellow-400'); 
            }
        }

        function revealAllTranslations() {
            document.querySelectorAll('.option-btn').forEach(button => {
                revealTranslation(button);
            });
        }

        // Corrected Quiz Logic
        function checkAnswer(button, isCorrect) {
            if (isProcessing) return;
            isProcessing = true;
            
            // Temporarily disable ALL buttons during processing/feedback period
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
            
            if (isCorrect) {
                // Correct Answer Logic
                button.classList.add('correct');
                revealAllTranslations(); 

                showFeedback("Correct! You successfully communicated the phrase.", 'correct');
                
                const dest = GAME_DATA[currentDestinationId];
                const adventure = dest.adventures[currentAdventureIndex];
                
                if (currentSceneIndex < adventure.scenes.length - 1) {
                    document.getElementById('continueButton').textContent = `Continue Touring (${currentSceneIndex + 1}/${adventure.scenes.length} Scenes)`;
                    document.getElementById('continueButton').classList.remove('hidden');
                } else {
                    // It's the last scene
                    const completeButton = document.getElementById('completeAdventureButton');
                    
                    if (isReviewMode) {
                        // Display review text
                        completeButton.textContent = "REVIEW COMPLETE: RETURN TO ADVENTURES";
                    } else {
                        // Display standard text for new badge
                        completeButton.textContent = "COMPLETE ADVENTURE AND EARN BADGE";
                    }
                    
                    completeButton.style.backgroundColor = 'var(--success-green)';
                    completeButton.style.boxShadow = '0 4px #276749';
                    completeButton.classList.remove('hidden');
                }
                
                isProcessing = false;
                // Buttons remain disabled here until the scene changes or the Continue button is clicked

            } else {
                // Incorrect Answer Logic
                button.classList.add('incorrect');
                revealTranslation(button); // Only reveal the translation of the incorrect card

                showFeedback("Incorrect. Try again!", 'incorrect');
                
                setTimeout(() => {
                    button.classList.remove('incorrect');
                    
                    // HIDE the incorrect translation hint after the pause
                    document.getElementById(`translation-${button.dataset.index}`).classList.add('opacity-0');
                    
                    // Re-enable ALL buttons (including the one just clicked)
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        btn.disabled = false;
                    });
                    
                    isProcessing = false;
                }, 1500); // Wait 1.5 seconds for feedback and hint display
            }
        }

        function completeAdventure() {
            const dest = GAME_DATA[currentDestinationId];
            const adventure = dest.adventures[currentAdventureIndex];
            const badgeId = `${currentDestinationId}-${adventure.id}`;
            let levelUp = false;
            let isNewBadge = false;

            if (!userProgress.badges.includes(badgeId)) {
                userProgress.badges.push(badgeId);
                isNewBadge = true;
                
                const currentBadgeCount = userProgress.badges.length;
                if (currentBadgeCount % 5 === 0) {
                    levelUp = true;
                }
                saveUserProgress();
            }
            
            // Show Badge Modal
            document.getElementById('modalBadgeName').textContent = adventure.badgeName;

            if (isNewBadge) {
                 document.getElementById('modalLevelMessage').textContent = levelUp 
                     ? `Congratulations! You leveled up to Level ${Math.floor(userProgress.badges.length / 5) + 1} and unlocked a new travel rank!` 
                     : `You earned a new badge! You now have ${userProgress.badges.length} of 30 mastery badges.`;
            } else {
                 document.getElementById('modalLevelMessage').textContent = `Great review! Progress saved, but no new badge was awarded. You currently hold ${userProgress.badges.length} mastery badges.`;
            }

            // Reset modal button for the badge modal
            const modalButton = document.getElementById('closeBadgeModal');
            modalButton.textContent = "Continue";
            modalButton.classList.remove('bg-gray-500', 'hover:bg-gray-600', 'shadow-gray-700');
            modalButton.classList.add('bg-red-500', 'hover:bg-red-400', 'shadow-red-700');


            document.getElementById('badgeModal').classList.remove('hidden');
            // Hide scene buttons just in case
            document.getElementById('continueButton').classList.add('hidden');
            document.getElementById('completeAdventureButton').classList.add('hidden');
            
            isReviewMode = false; // Reset review mode after completion
        }

        // --- PROGRESS TRACKER LOGIC (UPDATED FOR 6x5 GRID WITH HEADERS) ---

        function renderProgressTracker() {
            const currentBadges = userProgress.badges.length;
            
            document.getElementById('progressUserId').textContent = userId;
            
            // Logic to determine the current/next country for the main panel
            const countries = Object.keys(GAME_DATA);
            let currentCountryKey = 'japan';
            for (const [key, data] of Object.entries(GAME_DATA)) {
                if (currentBadges < data.requiredBadges) break;
                currentCountryKey = key;
            }
            const currentCountry = GAME_DATA[currentCountryKey];
            const nextCountryIndex = countries.indexOf(currentCountryKey) + 1;
            const nextCountry = nextCountryIndex < countries.length ? GAME_DATA[countries[nextCountryIndex]] : { name: "Global Master", rank: "Legend" };

            const completedInCurrent = userProgress.badges.filter(b => b.startsWith(currentCountryKey)).length;


            document.getElementById('rankCountryName').textContent = `${currentCountry.name} (${currentCountry.adventures[0]?.rank || 'Traveler'})`;
            document.getElementById('rankCountryCode').textContent = currentCountry.code;
            document.getElementById('adventuresCompleted').textContent = completedInCurrent;
            document.querySelector('#progressScreen .text-sm.mt-2').textContent = `Next Rank: ${nextCountry.name} (${nextCountry.adventures[0]?.rank || nextCountry.rank})`;


            const badgeContainer = document.getElementById('badgeContainer');
            badgeContainer.innerHTML = '';
            
            // NEW LOGIC: Iterate through countries, adding a header for each row of 5 badges
            Object.entries(GAME_DATA).forEach(([countryId, country]) => {
                
                // 1. Add the Country Header for the row
                const header = document.createElement('div');
                header.classList.add('badge-row-header');
                const isCountryUnlocked = currentBadges >= country.requiredBadges;
                header.innerHTML = `${isCountryUnlocked ? '✅' : '🔒'} ${country.name} (${country.adventures[0]?.rank || 'Rank'})`;
                badgeContainer.appendChild(header);

                // 2. Add the 5 Badges for this country
                country.adventures.forEach((adventure, advIndex) => {
                    
                    // --- Create the square aspect ratio wrapper ---
                    const badgeWrapper = document.createElement('div');
                    badgeWrapper.classList.add('badge-square-wrapper');
                    
                    // --- Create the content container (the actual visual badge) ---
                    const badgeBox = document.createElement('div');
                    // Use the custom style to hold the content
                    badgeBox.classList.add('badge-grid-content'); 
                    
                    const badgeId = `${countryId}-${adventure.id}`;
                    const isEarned = userProgress.badges.includes(badgeId);
                    
                    if (isEarned) {
                         // Apply earned classes
                         badgeBox.classList.add('bg-green-600', 'border-green-400', 'text-white', 'cursor-pointer');
                    } else if (isCountryUnlocked) {
                         // Apply unlocked but not earned classes
                         badgeBox.classList.add('bg-gray-800', 'border-yellow-400', 'text-yellow-400');
                    } else {
                         // Apply locked classes
                         badgeBox.classList.remove('active-dest');
                         badgeBox.classList.add('bg-gray-700', 'border-gray-500', 'text-gray-400', 'opacity-50');
                    }

                    badgeBox.innerHTML = `
                        <div class="text-2xl font-black ${isEarned ? 'text-white' : country.color}">${country.code}</div>
                        <div class="text-xs font-semibold mt-1">${adventure.badgeName}</div>
                        <div class="text-xs mt-1 ${isEarned ? 'text-white' : 'text-gray-400'}">${advIndex + 1}/5</div>
                    `;
                    
                    // Assemble the wrapper and content
                    badgeWrapper.appendChild(badgeBox);
                    badgeContainer.appendChild(badgeWrapper);
                });
            });
        }
        
        // --- PROFILE LOGIC ---
        
        // Simplified: removed all config key display logic
        function renderProfileScreen() {
            document.getElementById('profileUserId').textContent = userId;
            const profile = userProgress.profile || { name: "", email: "" };
            document.getElementById('travelerNameInput').value = profile.name || "";
            document.getElementById('emailInput').value = profile.email || "";
        }

        // FIX: Added explicit renderUI() call to ensure greeting updates immediately
        document.getElementById('saveProfileButton').addEventListener('click', () => {
            const name = document.getElementById('travelerNameInput').value.trim();
            const email = document.getElementById('emailInput').value.trim();

            userProgress.profile = { name, email };
            saveUserProgress();
            
            // Update the greeting immediately
            renderUI();

            showFeedback("Profile Saved!", 'correct');
        });
        
        // --- SETTINGS LOGIC ---

        function applySettings() {
            const settings = userProgress.settings || {};
            
            // Theme
            const theme = settings.theme || 'dark-mode';
            document.body.className = theme;
            document.getElementById('themeToggle').checked = theme === 'light-mode';
            
            // Music Volume/Mute
            document.getElementById('musicVolume').value = settings.musicVolume || 0.2;
            document.getElementById('musicMuteToggle').checked = settings.musicMuted || false;
            setBackgroundMusicState(settings.musicVolume || 0.2, settings.musicMuted || false);

            // Audio Volume/Mute
            document.getElementById('audioVolume').value = settings.audioVolume || 1.0;
            document.getElementById('audioMuteToggle').checked = settings.audioMuted || false;
        }
        
        // --- EVENT HANDLERS FOR SETTINGS ---

        document.getElementById('themeToggle').addEventListener('change', (e) => {
            const theme = e.target.checked ? 'light-mode' : 'dark-mode';
            document.body.className = theme;
            userProgress.settings.theme = theme;
            saveUserProgress();
        });

        // Music Mute Toggle Listener
        document.getElementById('musicMuteToggle').addEventListener('change', (e) => {
            const isMuted = e.target.checked;
            userProgress.settings.musicMuted = isMuted;
            
            if (isMuted) {
                setBackgroundMusicState(userProgress.settings.musicVolume, true);
            } else {
                setBackgroundMusicState(userProgress.settings.musicVolume, false);
            }
            saveUserProgress();
        });

        document.getElementById('musicVolume').addEventListener('input', (e) => {
            const newVolume = parseFloat(e.target.value);
            userProgress.settings.musicVolume = newVolume;
            userProgress.settings.musicMuted = (newVolume === 0);
            
            document.getElementById('musicMuteToggle').checked = (newVolume === 0);

            setBackgroundMusicState(newVolume, (newVolume === 0));
            saveUserProgress();
        });

        // Audio Mute Toggle Listener
        document.getElementById('audioMuteToggle').addEventListener('change', (e) => {
            const isMuted = e.target.checked;
            userProgress.settings.audioMuted = isMuted;

            if (isMuted) {
                document.getElementById('audioVolume').value = 0;
            } else {
                document.getElementById('audioVolume').value = userProgress.settings.audioVolume || 1.0;
            }
            saveUserProgress();
        });

        document.getElementById('audioVolume').addEventListener('input', (e) => {
            const newVolume = parseFloat(e.target.value);
            userProgress.settings.audioVolume = newVolume;
            userProgress.settings.audioMuted = (newVolume === 0);
            
            document.getElementById('audioMuteToggle').checked = (newVolume === 0);

            saveUserProgress();
        });


        // --- INITIALIZATION AND EVENT LISTENERS ---

        function setupEventListeners() {
            // General button listeners for screen switching
            document.getElementById('startButton').addEventListener('click', () => {
                attemptMusicPlay(); 
                switchScreen('destinationScreen');
            });

            document.getElementById('profileButton').addEventListener('click', () => switchScreen('profileScreen'));
            document.getElementById('progressButton').addEventListener('click', () => switchScreen('progressScreen'));
            document.getElementById('settingsButton').addEventListener('click', () => switchScreen('settingsScreen'));
            
            // CRITICAL FIX: When closing the modal, re-render the adventure screen
            document.getElementById('closeBadgeModal').addEventListener('click', () => {
                document.getElementById('badgeModal').classList.add('hidden');
                // Force a re-render of the adventure screen to show unlocked state
                renderAdventureScreen(currentDestinationId);
            });
            
            // Expose game functions to global scope for HTML onclicks
            window.startAdventure = startAdventure;
            window.nextScene = nextScene;
            window.completeAdventure = completeAdventure;

            // Handle all 'Back' buttons and View Progress button
            document.querySelectorAll('button[data-target]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const target = e.currentTarget.dataset.target;
                    switchScreen(target);
                });
            });
            
            // Handle quick access navigation
            document.getElementById('quickSettingsButton').addEventListener('click', () => switchScreen('settingsScreen'));
            document.getElementById('quickHomeButton').addEventListener('click', () => switchScreen('titlePage'));
        }

        // Updated: Added Traveler Name to UI
        function renderUI() {
            const travelerName = userProgress.profile?.name || "Traveler";
            const greetingEl = document.getElementById('travelerGreeting');
            if (greetingEl) {
                greetingEl.textContent = `Welcome, ${travelerName}!`;
            }
            
            renderDestinationScreen();
            renderProgressTracker();
            applySettings();
        }

        // Initialize on load
        window.onload = () => {
            userProgress = { 
                badges: [], 
                profile: { name: "Traveler", email: "" },
                settings: { theme: 'dark-mode', musicVolume: 0.2, audioVolume: 1.0, musicMuted: false, audioMuted: false }, 
            };
            
            const musicVolumeSlider = document.getElementById('musicVolume');
            if (musicVolumeSlider) {
                musicVolumeSlider.value = userProgress.settings.musicVolume;
            }
            
            renderUI(); 
            setupEventListeners();
            initFirebase();
        };

    </script>
</body>
</html>
